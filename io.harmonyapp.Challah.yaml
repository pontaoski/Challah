app-id: io.harmonyapp.Challah
runtime: org.kde.Platform
runtime-version: "5.15"
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
command: Challah
finish-args:
  - --share=ipc
  - --device=dri
  - --socket=x11
  - --socket=wayland
  - --share=network
  - --filesystem=xdg-config/kdeglobals:ro
  - --filesystem=home
cleanup:
  - /bin/a*
  - /bin/grpc*
  - /bin/protoc*
  - /bin/qbs*
  - /include
  - /lib/*.a
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/qbs
  - /lib/libqbs*
  - /libexec
  - /share/ECM
  - /share/man
  - /share/pkgconfig
  - /share/qbs

modules:
# hrpc
  - name: hrpc
    buildsystem: simple
    sources:
      - type: file
        path: protoc-gen-hrpc
    build-commands:
      - install -Dm755 protoc-gen-hrpc /app/bin/protoc-gen-hrpc
# protoc
  - name: protobuf
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v3.18.1/protobuf-cpp-3.18.1.tar.gz
        sha256: 6ee35eda3f79e49608d2ace8d866313fdec539d8bb14c6c54e8d2a16fa4e6780
# stuff we modify
  - name: qbs
    buildsystem: qmake
    config-opts:
    - QBS_INSTALL_PREFIX=/app
    sources:
      - type: git
        url: https://code.qt.io/qbs/qbs.git
        branch: 1.18
# gstreamer
  - buildsystem: meson
    name: gstreamer
    sources:
      - commit: 71c213f99ad5c8fc8f36a26238483f2bdf7d846a
        tag: 1.18.5
        type: git
        url: https://gitlab.freedesktop.org/gstreamer/gstreamer.git
  - config-opts:
      - -Dcompositor=enabled
      - -Dgl=enabled
    buildsystem: meson
    name: gstreamer-plugins-base
    sources:
      - commit: 57fb883b3f8c6d7a397afc0dfc4a7c2e5af05579
        tag: 1.18.5
        type: git
        url: https://gitlab.freedesktop.org/gstreamer/gst-plugins-base.git
  - config-opts:
      - -Dpulse=enabled
      - -Dqt5=enabled
      - -Drtp=enabled
      - -Drtpmanager=enabled
      - -Dvpx=enabled
    buildsystem: meson
    name: gstreamer-plugins-good
    sources:
      - commit: 56dec037a80266add6853e4b06e2dc379de757d1
        tag: 1.18.5
        type: git
        url: https://gitlab.freedesktop.org/gstreamer/gst-plugins-good.git
  - config-opts:
      - -Ddtls=enabled
      - -Dgl=enabled
      - -Dopenh264=enabled
      - -Dopus=enabled
      - -Dsrtp=enabled
      - -Dwebrtc=enabled
      - -Dflite=disabled
    buildsystem: meson
    name: gstreamer-plugins-bad
    sources:
      - commit: d3af58d5b31941caa26c3ded85d7a7b84a91f0cc
        tag: 1.18.5
        type: git
        url: https://gitlab.freedesktop.org/gstreamer/gst-plugins-bad.git
# the app
  - name: harmony-protocols
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DUSE_STAGING_PROTOCOLS=on
    sources:
      - type: git
        url: https://github.com/harmony-development/protocol.git
        branch: main
  - name: challah
    buildsystem: simple
    post-install:
    - cp -r release/install-root/app/bin/Challah /app/bin/
    - cp -r release/install-root/app/share/* /app/share/
    build-commands:
      - qbs config:release modules.cpp.treatWarningsAsErrors:false 'products.HarmonyProtocol.protocolPath:"/app/include/harmony-protocols"' installPrefix:/app -j2
    sources:
      - type: git
        url: https://github.com/harmony-development/Challah
        branch: oven
